<template>
  <div class="user-profile-form-container">
    <div class="form-header">
      <h3>ğŸ“‹ åˆå§‹å­¦ä¹ çŠ¶æ€è¯„ä¼°</h3>
      <p class="form-description">è¯·è¯¦ç»†å¡«å†™æ‚¨çš„å­¦ä¹ æƒ…å†µï¼Œè¿™å°†å¸®åŠ©æˆ‘ä»¬ä¸ºæ‚¨åˆ¶å®šæ›´ä¸ªæ€§åŒ–çš„å­¦ä¹ è®¡åˆ’</p>
    </div>

    <form @submit.prevent="submitForm" class="profile-form">
      <!-- åŸºæœ¬ä¿¡æ¯ -->
      <div class="form-section">
        <h4 class="section-title">åŸºæœ¬ä¿¡æ¯</h4>
        
        <div class="form-group">
          <label for="current_school">ç›®å‰å°±è¯»é™¢æ ¡ <span class="required">*</span></label>
          <input
            id="current_school"
            v-model="formData.current_school"
            type="text"
            placeholder="ä¾‹å¦‚ï¼šå››å·å¤§å­¦"
            required
          />
        </div>

        <div class="form-group">
          <label for="current_major">å°±è¯»ä¸“ä¸š <span class="required">*</span></label>
          <input
            id="current_major"
            v-model="formData.current_major"
            type="text"
            placeholder="ä¾‹å¦‚ï¼šè®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯"
            required
          />
        </div>

        <div class="form-group">
          <label for="grade">å¹´çº§ <span class="required">*</span></label>
          <select id="grade" v-model="formData.grade" required>
            <option value="">è¯·é€‰æ‹©</option>
            <option value="å¤§ä¸€">å¤§ä¸€</option>
            <option value="å¤§äºŒ">å¤§äºŒ</option>
            <option value="å¤§ä¸‰">å¤§å››</option>
            <option value="å¤§å››">å¤§å››</option>
            <option value="å·²æ¯•ä¸š">å·²æ¯•ä¸š</option>
          </select>
        </div>
      </div>

      <!-- å­¦ä¹ æƒ…å†µ -->
      <div class="form-section">
        <h4 class="section-title">å­¦ä¹ æƒ…å†µ</h4>
        
        <div class="form-group">
          <label for="major_courses">ä¸“ä¸šè¯¾å­¦ä¹ æƒ…å†µ <span class="required">*</span></label>
          <textarea
            id="major_courses"
            v-model="formData.major_courses"
            rows="3"
            placeholder="è¯·æè¿°æ‚¨çš„ä¸“ä¸šè¯¾å­¦ä¹ æƒ…å†µï¼ŒåŒ…æ‹¬å·²å­¦è¯¾ç¨‹ã€æŒæ¡ç¨‹åº¦ã€è–„å¼±ç¯èŠ‚ç­‰"
            required
          ></textarea>
        </div>

        <div class="form-group">
          <label for="public_courses">å…¬å…±è¯¾å­¦ä¹ æƒ…å†µ <span class="required">*</span></label>
          <textarea
            id="public_courses"
            v-model="formData.public_courses"
            rows="3"
            placeholder="è¯·æè¿°æ‚¨çš„æ•°å­¦ã€è‹±è¯­ã€æ”¿æ²»ç­‰å…¬å…±è¯¾å­¦ä¹ æƒ…å†µ"
            required
          ></textarea>
        </div>

        <div class="form-group">
          <label for="learning_motivation">å­¦ä¹ ç§¯ææ€§ <span class="required">*</span></label>
          <select id="learning_motivation" v-model="formData.learning_motivation" required>
            <option value="">è¯·é€‰æ‹©</option>
            <option value="éå¸¸é«˜">éå¸¸é«˜</option>
            <option value="è¾ƒé«˜">è¾ƒé«˜</option>
            <option value="ä¸€èˆ¬">ä¸€èˆ¬</option>
            <option value="è¾ƒä½">è¾ƒä½</option>
            <option value="éœ€è¦æå‡">éœ€è¦æå‡</option>
          </select>
        </div>

        <div class="form-group">
          <label for="daily_study_time">æ¯å¤©å¯ç”¨äºå¤‡æˆ˜è€ƒç ”çš„æ—¶é—´ <span class="required">*</span></label>
          <select id="daily_study_time" v-model="formData.daily_study_time" required>
            <option value="">è¯·é€‰æ‹©</option>
            <option value="1-2å°æ—¶">1-2å°æ—¶</option>
            <option value="3-4å°æ—¶">3-4å°æ—¶</option>
            <option value="5-6å°æ—¶">5-6å°æ—¶</option>
            <option value="7-8å°æ—¶">7-8å°æ—¶</option>
            <option value="8å°æ—¶ä»¥ä¸Š">8å°æ—¶ä»¥ä¸Š</option>
          </select>
        </div>
      </div>

      <!-- å¿ƒç†çŠ¶æ€ -->
      <div class="form-section">
        <h4 class="section-title">å¿ƒç†çŠ¶æ€</h4>
        
        <div class="form-group">
          <label for="has_pressure">æ˜¯å¦æœ‰å‹åŠ› <span class="required">*</span></label>
          <select id="has_pressure" v-model="formData.has_pressure" required>
            <option value="">è¯·é€‰æ‹©</option>
            <option value="å‹åŠ›å¾ˆå¤§">å‹åŠ›å¾ˆå¤§</option>
            <option value="æœ‰ä¸€å®šå‹åŠ›">æœ‰ä¸€å®šå‹åŠ›</option>
            <option value="å‹åŠ›é€‚ä¸­">å‹åŠ›é€‚ä¸­</option>
            <option value="å‹åŠ›è¾ƒå°">å‹åŠ›è¾ƒå°</option>
            <option value="æ²¡æœ‰å‹åŠ›">æ²¡æœ‰å‹åŠ›</option>
          </select>
        </div>

        <div class="form-group">
          <label for="why_graduate">ä¸ºä»€ä¹ˆè¦è€ƒç ” <span class="required">*</span></label>
          <textarea
            id="why_graduate"
            v-model="formData.why_graduate"
            rows="3"
            placeholder="è¯·æè¿°æ‚¨è€ƒç ”çš„åŠ¨æœºå’Œç›®æ ‡ï¼Œä¾‹å¦‚ï¼šæå‡å­¦å†ã€è½¬ä¸“ä¸šã€å­¦æœ¯ç ”ç©¶ç­‰"
            required
          ></textarea>
        </div>
      </div>

      <!-- å­¦ä¹ èµ„æº -->
      <div class="form-section">
        <h4 class="section-title">å­¦ä¹ èµ„æº</h4>
        
        <div class="form-group">
          <label for="has_study_materials">æ˜¯å¦æœ‰è‡ªå·±çš„å­¦ä¹ èµ„æ–™ <span class="required">*</span></label>
          <select id="has_study_materials" v-model="formData.has_study_materials" required>
            <option value="">è¯·é€‰æ‹©</option>
            <option value="æœ‰å®Œæ•´èµ„æ–™">æœ‰å®Œæ•´èµ„æ–™ï¼ˆæ•™æã€çœŸé¢˜ã€è¾…å¯¼ä¹¦ç­‰ï¼‰</option>
            <option value="æœ‰éƒ¨åˆ†èµ„æ–™">æœ‰éƒ¨åˆ†èµ„æ–™</option>
            <option value="èµ„æ–™è¾ƒå°‘">èµ„æ–™è¾ƒå°‘</option>
            <option value="æ²¡æœ‰èµ„æ–™">æ²¡æœ‰èµ„æ–™</option>
          </select>
        </div>

        <div class="form-group">
          <label for="has_tutoring">æ˜¯å¦æŠ¥äº†è¾…å¯¼ç­</label>
          <select id="has_tutoring" v-model="formData.has_tutoring">
            <option value="">è¯·é€‰æ‹©</option>
            <option value="å·²æŠ¥ç­">å·²æŠ¥ç­</option>
            <option value="è®¡åˆ’æŠ¥ç­">è®¡åˆ’æŠ¥ç­</option>
            <option value="ä¸æŠ¥ç­">ä¸æŠ¥ç­</option>
          </select>
        </div>

        <div v-if="formData.has_tutoring === 'å·²æŠ¥ç­'" class="form-group">
          <label for="tutoring_details">è¾…å¯¼ç­è¯¦æƒ…</label>
          <input
            id="tutoring_details"
            v-model="formData.tutoring_details"
            type="text"
            placeholder="ä¾‹å¦‚ï¼šæ–°ä¸œæ–¹æ•°å­¦å¼ºåŒ–ç­"
          />
        </div>
      </div>

      <!-- è‹±è¯­æ°´å¹³ -->
      <div class="form-section">
        <h4 class="section-title">è‹±è¯­æ°´å¹³</h4>
        
        <div class="form-group">
          <label for="english_level">è‹±è¯­æ°´å¹³ <span class="required">*</span></label>
          <select id="english_level" v-model="formData.english_level" required>
            <option value="">è¯·é€‰æ‹©</option>
            <option value="å››çº§æœªè¿‡">å››çº§æœªè¿‡</option>
            <option value="å››çº§å·²è¿‡">å››çº§å·²è¿‡</option>
            <option value="å…­çº§å·²è¿‡">å…­çº§å·²è¿‡</option>
            <option value="é›…æ€">é›…æ€ï¼ˆè¯·å¡«å†™åˆ†æ•°ï¼‰</option>
            <option value="æ‰˜ç¦">æ‰˜ç¦ï¼ˆè¯·å¡«å†™åˆ†æ•°ï¼‰</option>
            <option value="å…¶ä»–">å…¶ä»–</option>
          </select>
        </div>

        <div v-if="formData.english_level === 'é›…æ€' || formData.english_level === 'æ‰˜ç¦'" class="form-group">
          <label for="english_score">åˆ†æ•°</label>
          <input
            id="english_score"
            v-model="formData.english_score"
            type="text"
            placeholder="ä¾‹å¦‚ï¼šé›…æ€ 7.0 æˆ– æ‰˜ç¦ 100"
          />
        </div>
      </div>

      <!-- å…¶ä»–ä¿¡æ¯ -->
      <div class="form-section">
        <h4 class="section-title">å…¶ä»–ä¿¡æ¯</h4>
        
        <div class="form-group">
          <label for="additional_info">å…¶ä»–éœ€è¦è¯´æ˜çš„æƒ…å†µ</label>
          <textarea
            id="additional_info"
            v-model="formData.additional_info"
            rows="3"
            placeholder="ä¾‹å¦‚ï¼šæœ‰å®ä¹ ç»å†ã€å‚åŠ è¿‡ç«èµ›ã€æœ‰ç§‘ç ”ç»å†ç­‰"
          ></textarea>
        </div>
      </div>

      <!-- æäº¤æŒ‰é’® -->
      <div class="form-actions">
        <button type="submit" class="btn-submit" :disabled="submitting">
          <span v-if="submitting">æäº¤ä¸­...</span>
          <span v-else>æäº¤è¯„ä¼°</span>
        </button>
      </div>

      <!-- é”™è¯¯æç¤º -->
      <div v-if="error" class="error-message">
        {{ error }}
      </div>
    </form>
  </div>
</template>

<script setup>
import { ref } from 'vue'
import api from '@/services/api'

const props = defineProps({
  goalId: {
    type: Number,
    required: true
  },
  nodeId: {
    type: Number,
    required: true
  }
})

const emit = defineEmits(['submitted', 'close'])

const formData = ref({
  current_school: '',
  current_major: '',
  grade: '',
  major_courses: '',
  public_courses: '',
  learning_motivation: '',
  daily_study_time: '',
  has_pressure: '',
  why_graduate: '',
  has_study_materials: '',
  has_tutoring: '',
  tutoring_details: '',
  english_level: '',
  english_score: '',
  additional_info: ''
})

const submitting = ref(false)
const error = ref('')

async function submitForm() {
  if (submitting.value) return
  
  submitting.value = true
  error.value = ''
  
  try {
    const response = await api.post(`/goals/${props.goalId}/profile/update`, {
      node_id: props.nodeId,
      profile_data: formData.value
    })
    
    if (response.data && response.data.success) {
      // ç¡®ä¿regeneratingæ ‡å¿—æ­£ç¡®ä¼ é€’
      const regenerating = response.data.regenerating !== undefined ? response.data.regenerating : true
      console.log('[UserProfileForm] æäº¤æˆåŠŸï¼Œregenerating:', regenerating)
      
      // æ˜¾ç¤ºæˆåŠŸæç¤º
      const { toast } = await import('@/utils/toast')
      toast.success('ç”¨æˆ·ç”»åƒå·²æˆåŠŸæ›´æ–°')
      
      emit('submitted', {
        nodeId: props.nodeId,
        profileData: formData.value,
        regenerating: regenerating
      })
    } else {
      const errorMsg = response.data?.message || 'æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•'
      error.value = errorMsg
      
      // æ˜¾ç¤ºé”™è¯¯æç¤º
      const { toast } = await import('@/utils/toast')
      toast.error(errorMsg)
    }
  } catch (err) {
    console.error('æäº¤ç”¨æˆ·ç”»åƒå¤±è´¥:', err)
    // æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
    let errorMsg = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•'
    if (err.response) {
      // æœåŠ¡å™¨è¿”å›äº†é”™è¯¯å“åº”
      errorMsg = err.response.data?.message || err.response.data?.error || `æœåŠ¡å™¨é”™è¯¯: ${err.response.status} ${err.response.statusText}`
    } else if (err.request) {
      // è¯·æ±‚å·²å‘å‡ºä½†æ²¡æœ‰æ”¶åˆ°å“åº”
      errorMsg = 'ç½‘ç»œé”™è¯¯ï¼šæ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥'
    } else {
      // å…¶ä»–é”™è¯¯
      errorMsg = err.message || 'æœªçŸ¥é”™è¯¯ï¼Œè¯·é‡è¯•'
    }
    error.value = errorMsg
    
    // æ˜¾ç¤ºé”™è¯¯æç¤º
    const { toast } = await import('@/utils/toast')
    toast.error(errorMsg)
  } finally {
    submitting.value = false
  }
}
</script>

<style scoped>
.user-profile-form-container {
  padding: 24px;
  background: white;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  max-width: 800px;
  margin: 0 auto;
}

.form-header {
  margin-bottom: 24px;
  text-align: center;
}

.form-header h3 {
  font-size: 24px;
  color: #333;
  margin-bottom: 8px;
}

.form-description {
  color: #666;
  font-size: 14px;
}

.profile-form {
  display: flex;
  flex-direction: column;
  gap: 24px;
}

.form-section {
  border: 1px solid #e0e0e0;
  border-radius: 8px;
  padding: 20px;
  background: #fafafa;
}

.section-title {
  font-size: 18px;
  color: #667eea;
  margin-bottom: 16px;
  padding-bottom: 8px;
  border-bottom: 2px solid #667eea;
}

.form-group {
  margin-bottom: 16px;
}

.form-group:last-child {
  margin-bottom: 0;
}

.form-group label {
  display: block;
  margin-bottom: 6px;
  font-weight: 500;
  color: #333;
  font-size: 14px;
}

.required {
  color: #dc3545;
}

.form-group input,
.form-group select,
.form-group textarea {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid #ddd;
  border-radius: 6px;
  font-size: 14px;
  font-family: inherit;
  transition: border-color 0.3s;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.form-group textarea {
  resize: vertical;
  min-height: 80px;
}

.form-actions {
  margin-top: 8px;
  text-align: center;
}

.btn-submit {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
  padding: 12px 48px;
  border-radius: 8px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: transform 0.2s, box-shadow 0.2s;
}

.btn-submit:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

.btn-submit:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.error-message {
  margin-top: 16px;
  padding: 12px;
  background: #ffe6e6;
  border: 1px solid #ff9999;
  border-radius: 6px;
  color: #cc0000;
  text-align: center;
}
</style>

